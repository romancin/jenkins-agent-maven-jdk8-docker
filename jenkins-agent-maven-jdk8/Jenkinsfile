pipeline {
  agent none
  environment {
      NEXUS_DOCKER_REPOSITORY_URL = "https://nexus-registry.computeboxapps.familiamc.es/repository/docker-internal"
      NEXUS_IMAGE_NAME = "docker-internal/jenkins-agents/jenkins-agent-jdk8"
      NEXUS_IMAGE_TAG = "latest"
  }
  stages {
    stage('Docker Build') {
      agent any
      steps {
        sh 'docker build -t ${NEXUS_DOCKER_REPOSITORY_URL}/${NEXUS_IMAGE_NAME}:${NEXUS_IMAGE_TAG} .'
      }
    }
    stage('Docker Push') {
      agent any
      steps {
        withCredentials([usernamePassword(credentialsId: 'nexus-credentials', passwordVariable: 'NexusPassword', usernameVariable: 'NexusUser')]) {
          sh "docker login -u ${env.NexusUser} -p ${env.NexusPassword}"
          sh 'docker push ${NEXUS_IMAGE_NAME}:${NEXUS_IMAGE_TAG}'
        }
      }
    }
  }
}
